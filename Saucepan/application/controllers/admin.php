<?phpif (! defined ( 'BASEPATH' ))	exit ( 'No direct script access allowed' );class Admin extends CI_Controller {	function __construct() {		session_start();		parent::__construct ();// 		$this->session->set_userdata ( 'menu', 'home' );				$lang = $this->session->userdata('lang');		if($lang == 'ch'){		    $this->session->set_userdata('lang','ch');		    $this->langtype='_ch';		    $this->lang->load('gksel','chinese');		    		}else{		    $this->session->set_userdata('lang','en');		    $this->langtype='_en';		    $this->lang->load('gksel','english');		}		$this->lang->load('gksel','chinese');	// function index(){	// $this->load->view ( 'admin/home_list');	// }	}	function index() {		if(isset($_COOKIE[DB_PRE().'admininfo'])){			$admininfo = unserialize($_COOKIE[DB_PRE().'admininfo']);			$admin_id = $admininfo['admin_id'];			$admin_username = $admininfo['admin_username'];		}else{			$admin_id = 0;			$admin_username = '';		}		if ($admin_id != 0 && $admin_username != '') {			redirect ( base_url () . 'index.php/admins/cms/bannersublist/2' );		} else {			// $this->load->view ( 'admin/hlogin' );
			$this->load->view ( 'admins/sign_in' );		}	}	function tologin() {		$ishaveyanzhengma = strip_tags ( $this->input->post ( 'ishaveyanzhengma' ) );		$aname = strip_tags ( $this->input->post ( 'aname' ) );		$apass = strip_tags ( $this->input->post ( 'apass' ) );		$ispass = 1;		$result = $this->AdminModel->checkAdmin ( $aname, md5 ( $apass ) );		$result_username = $this->AdminModel->checkAdmin_username ( $aname );				if (! empty ( $_SERVER ["HTTP_CLIENT_IP"] )) {			$ip_address = $_SERVER ["HTTP_CLIENT_IP"];		} elseif (! empty ( $_SERVER ["HTTP_X_FORWARDED_FOR"] )) {			$ip_address = $_SERVER ["HTTP_X_FORWARDED_FOR"];		} elseif (! empty ( $_SERVER ["REMOTE_ADDR"] )) {			$ip_address = $_SERVER ["REMOTE_ADDR"];		} else {			$ip_address = "127.0.0.1";		}		if ($ip_address == '::1') {			$ip_address = '127.0.0.1';		}				if(!empty($result_username)){			//添加后台管理员登录日志--开始				$err_num = 0;				$sql = "SELECT * FROM ".DB_PRE()."admin_login WHERE ip_address = '".$ip_address."' ORDER BY created DESC LIMIT 0, 5";				$resdlogin = $this->db->query($sql)->result_array();				if (!empty($resdlogin)) {					for ($i = 0; $i < count($resdlogin); $i++) {						if($resdlogin[$i]['status'] == 0){							$err_num = $err_num + 1;						}					}				}				if($err_num >= 3){					$data ['ishaveyanzhengma'] = 1;				}				if($err_num == 5){					if(($resdlogin[0]['created']+600) > mktime()){						$data ['error'] = 'Please log in after ten minutes';						$this->load->view ( 'admin/hlogin', $data );						return ;exit;					}				}			//添加后台管理员登录日志--结束		}				if($ishaveyanzhengma == 1){			$code=$this->input->post('code');			if(strtolower($code)!=strtolower ($_SESSION ["yan"])){				$data ['code_error'] = 'Verification code error';				$this->load->view ( 'admin/hlogin', $data );				return ;exit;			}		}								if ($result) {						// 正常返回数据(json)			$arr = array('admin_id'=>$result ['admin_id'], 'admin_username'=>$result['admin_username']);			$arr = serialize($arr);			set_cookie(DB_PRE().'admininfo',$arr, time() + 3600*10);//设置登录的session						//添加后台管理员登录日志--开始				$arr = array('status'=>1, 'admin_id'=>$result ['admin_id'], 'IP_address'=>$ip_address, 'created'=>mktime(), 'date_year'=>date('Y'), 'date_month'=>date('m'), 'date_day'=>date('d'));				$this->db->insert(DB_PRE().'admin_login', $arr);			//添加后台管理员登录日志--结束						redirect ( base_url () . 'index.php/admins/cms/bannersublist/2' );		} else {			if ($result == "" && $aname != '' && $apass != '') {				$ispass = 0;				$data ['error'] = 'Username or password error';												if(!empty($result_username)){					//添加后台管理员登录日志--开始						$arr = array('status'=>0, 'admin_id'=>$result_username ['admin_id'], 'IP_address'=>$ip_address, 'created'=>mktime(), 'date_year'=>date('Y'), 'date_month'=>date('m'), 'date_day'=>date('d'));						$this->db->insert(DB_PRE().'admin_login', $arr);					//添加后台管理员登录日志--结束				}else{					//添加后台管理员登录日志--开始					$arr = array('status'=>0, 'admin_id'=>0, 'IP_address'=>$ip_address, 'created'=>mktime(), 'date_year'=>date('Y'), 'date_month'=>date('m'), 'date_day'=>date('d'));					$this->db->insert(DB_PRE().'admin_login', $arr);					//添加后台管理员登录日志--结束				}							}						if ($aname == '') {				$data ['aname_error'] = 'Please enter your username';				$ispass = 0;			}						if ($apass == '') {				$data ['apass_error'] = 'Please enter your password';				$ispass = 0;			}		}		if ($ispass == 0) {			$this->load->view ( 'admin/hlogin', $data );		}	}	function logout() {		delete_cookie(DB_PRE().'admininfo');		redirect ( base_url () . 'index.php/admin/index' );	}}

/* End of file welcome.php */
/* Location: ./application/controllers/welcome.php */